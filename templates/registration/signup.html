{% extends 'base_auth.html' %}
{% load static %}

{% block title %}Sign Up{% endblock %}

{% block content %}
<div class="auth-container bg-black">
    <div class="container py-5">
        <!-- Logo -->
        <div class="text-center mb-4">
            <a href="{% url 'home' %}" class="text-decoration-none">
                <span class="text-light fs-1 fw-bold">WatchBazaar</span>
                <span class="text-primary fs-4 fw-bold">PK</span>
            </a>
            <p class="text-muted mt-2">Create your buyer account</p>
        </div>
        
        <!-- Step Indicator -->
        <div class="step-indicator" id="stepIndicator">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
            </div>
        </div>
        
        <!-- Form Container -->
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                <div class="card bg-dark border-0 rounded-4 p-4 p-lg-5">
                    <form method="post" action="{% url 'signup' %}" id="signupForm">
                        {% csrf_token %}
                        
                        <!-- Step 1: Account Creation -->
                        <div class="form-step" id="step1">
                            <h4 class="text-uppercase text-light mb-4">Account Details</h4>
                            
                            <!-- Email -->
                            <div class="form-floating mb-3">
                                <input type="email" 
                                       class="form-control form-control-dark" 
                                       id="email" 
                                       name="email" 
                                       placeholder="Email address"
                                       required>
                                <label for="email">Email address</label>
                                <div class="invalid-feedback" id="emailError"></div>
                                <div class="valid-feedback text-success" id="emailValid">
                                    <small><span data-feather="check" style="width:12px;height:12px;"></span> Email available</small>
                                </div>
                            </div>
                            
                            <!-- Password -->
                            <div class="form-floating mb-2 position-relative">
                                <input type="password" 
                                       class="form-control form-control-dark" 
                                       id="password" 
                                       name="password" 
                                       placeholder="Password"
                                       minlength="8"
                                       required>
                                <label for="password">Password</label>
                                <span class="password-toggle" onclick="togglePassword('password', 'eyeIcon1')">
                                    <span data-feather="eye" id="eyeIcon1"></span>
                                </span>
                            </div>
                            <div class="password-strength-container mb-3">
                                <div class="password-strength" id="passwordStrength"></div>
                                <small class="text-muted" id="passwordHint">Minimum 8 characters</small>
                            </div>
                            
                            <!-- Confirm Password -->
                            <div class="form-floating mb-4 position-relative">
                                <input type="password" 
                                       class="form-control form-control-dark" 
                                       id="confirmPassword" 
                                       name="confirm_password" 
                                       placeholder="Confirm Password"
                                       required>
                                <label for="confirmPassword">Confirm Password</label>
                                <span class="password-toggle" onclick="togglePassword('confirmPassword', 'eyeIcon2')">
                                    <span data-feather="eye" id="eyeIcon2"></span>
                                </span>
                                <div class="invalid-feedback" id="confirmError">Passwords do not match</div>
                            </div>
                            
                            <!-- Terms -->
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="terms" name="terms" required>
                                <label class="form-check-label text-muted" for="terms">
                                    I agree to the <a href="{% url 'terms' %}" class="auth-link" target="_blank">Terms & Conditions</a> 
                                    and <a href="{% url 'privacy' %}" class="auth-link" target="_blank">Privacy Policy</a>
                                </label>
                            </div>
                            
                            <button type="button" class="btn btn-wb-primary btn-lg w-100" onclick="nextStep(2)">
                                Next <span data-feather="arrow-right" style="width:18px;height:18px;"></span>
                            </button>
                        </div>
                        
                        <!-- Step 2: Profile Setup -->
                        <div class="form-step d-none" id="step2">
                            <h4 class="text-uppercase text-light mb-4">Profile Information</h4>
                            
                            <!-- Full Name -->
                            <div class="form-floating mb-3">
                                <input type="text" 
                                       class="form-control form-control-dark" 
                                       id="fullName" 
                                       name="full_name" 
                                       placeholder="Full Name"
                                       required>
                                <label for="fullName">Full Name</label>
                            </div>
                            
                            <!-- Phone Number -->
                            <div class="mb-3">
                                <label class="form-label text-muted small">Phone Number</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark text-muted border-secondary">+92</span>
                                    <input type="tel" 
                                           class="form-control form-control-dark" 
                                           id="phone" 
                                           name="phone" 
                                           placeholder="3XX XXXXXXX"
                                           pattern="3[0-9]{2}[0-9]{7}"
                                           maxlength="10"
                                           required>
                                </div>
                                <small class="text-muted">Format: 3XX XXXXXXX</small>
                            </div>
                            
                            <!-- City -->
                            <div class="form-floating mb-3">
                                <select class="form-select form-control-dark" id="city" name="city" required>
                                    <option value="" disabled selected>Select your city</option>
                                    <option value="karachi">Karachi</option>
                                    <option value="lahore">Lahore</option>
                                    <option value="islamabad">Islamabad</option>
                                    <option value="rawalpindi">Rawalpindi</option>
                                    <option value="faisalabad">Faisalabad</option>
                                    <option value="multan">Multan</option>
                                    <option value="peshawar">Peshawar</option>
                                    <option value="quetta">Quetta</option>
                                    <option value="other">Other</option>
                                </select>
                                <label for="city">City</label>
                            </div>
                            
                            <!-- Address (Optional) -->
                            <div class="form-floating mb-4">
                                <textarea class="form-control form-control-dark" 
                                          id="address" 
                                          name="address" 
                                          placeholder="Complete Address"
                                          style="height: 100px"></textarea>
                                <label for="address">Complete Address (Optional)</label>
                            </div>
                            
                            <div class="d-flex gap-3">
                                <button type="button" class="btn btn-outline-light btn-lg flex-grow-1" onclick="prevStep(1)">
                                    <span data-feather="arrow-left" style="width:18px;height:18px;"></span> Back
                                </button>
                                <button type="button" class="btn btn-wb-primary btn-lg flex-grow-1" onclick="nextStep(3)">
                                    Next <span data-feather="arrow-right" style="width:18px;height:18px;"></span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Phone Verification -->
                        <div class="form-step d-none" id="step3">
                            <div class="text-center mb-4">
                                <div class="mb-3">
                                    <span data-feather="smartphone" style="width:48px;height:48px;color:var(--wb-primary);"></span>
                                </div>
                                <h4 class="text-uppercase text-light">Verify Your Phone</h4>
                                <p class="text-muted">
                                    We sent a 6-digit code to<br>
                                    <strong class="text-light">+92 <span id="displayPhone">XXX XXXXXXX</span></strong>
                                </p>
                            </div>
                            
                            <!-- OTP Input -->
                            <div class="d-flex justify-content-center gap-2 mb-4">
                                <input type="text" class="otp-input" maxlength="1" data-index="0">
                                <input type="text" class="otp-input" maxlength="1" data-index="1">
                                <input type="text" class="otp-input" maxlength="1" data-index="2">
                                <input type="text" class="otp-input" maxlength="1" data-index="3">
                                <input type="text" class="otp-input" maxlength="1" data-index="4">
                                <input type="text" class="otp-input" maxlength="1" data-index="5">
                            </div>
                            <input type="hidden" name="otp" id="otpHidden">
                            
                            <!-- Timer & Resend -->
                            <div class="text-center mb-4">
                                <p class="text-muted" id="resendTimer">
                                    Resend code in <span class="text-primary" id="countdown">0:59</span>
                                </p>
                                <button type="button" class="btn btn-link auth-link d-none" id="resendBtn" onclick="resendOTP()">
                                    Didn't receive? Resend Code
                                </button>
                            </div>
                            
                            <div class="d-flex gap-3">
                                <button type="button" class="btn btn-outline-light btn-lg flex-grow-1" onclick="prevStep(2)">
                                    <span data-feather="arrow-left" style="width:18px;height:18px;"></span> Back
                                </button>
                                <button type="submit" class="btn btn-wb-primary btn-lg flex-grow-1" id="verifyBtn">
                                    Verify & Complete
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Login Link -->
                <p class="text-center text-muted mt-4">
                    Already have an account? <a href="{% url 'login' %}" class="auth-link">Sign in</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentStep = 1;
    let countdownInterval;
    
    function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.setAttribute('data-feather', 'eye-off');
        } else {
            input.type = 'password';
            icon.setAttribute('data-feather', 'eye');
        }
        feather.replace();
    }
    
    function updateStepIndicator(step) {
        document.querySelectorAll('.step').forEach((el, index) => {
            el.classList.remove('active', 'completed');
            if (index + 1 < step) {
                el.classList.add('completed');
                el.querySelector('.step-number').innerHTML = '<span data-feather="check" style="width:16px;height:16px;"></span>';
            } else if (index + 1 === step) {
                el.classList.add('active');
                el.querySelector('.step-number').textContent = step;
            } else {
                el.querySelector('.step-number').textContent = index + 1;
            }
        });
        feather.replace();
    }
    
    function nextStep(step) {
        // Validate current step
        if (!validateStep(currentStep)) return;
        
        document.getElementById(`step${currentStep}`).classList.add('d-none');
        document.getElementById(`step${step}`).classList.remove('d-none');
        currentStep = step;
        updateStepIndicator(step);
        
        if (step === 3) {
            // Display phone number
            const phone = document.getElementById('phone').value;
            document.getElementById('displayPhone').textContent = phone;
            startCountdown();
            // Focus first OTP input
            document.querySelector('.otp-input').focus();
        }
        
        feather.replace();
    }
    
    function prevStep(step) {
        document.getElementById(`step${currentStep}`).classList.add('d-none');
        document.getElementById(`step${step}`).classList.remove('d-none');
        currentStep = step;
        updateStepIndicator(step);
        feather.replace();
    }
    
    function validateStep(step) {
        if (step === 1) {
            const email = document.getElementById('email');
            const password = document.getElementById('password');
            const confirmPassword = document.getElementById('confirmPassword');
            const terms = document.getElementById('terms');
            
            if (!email.value || !email.checkValidity()) {
                email.classList.add('is-invalid');
                return false;
            }
            
            if (password.value.length < 8) {
                password.classList.add('is-invalid');
                return false;
            }
            
            if (password.value !== confirmPassword.value) {
                confirmPassword.classList.add('is-invalid');
                return false;
            }
            
            if (!terms.checked) {
                alert('Please agree to the Terms & Conditions');
                return false;
            }
            
            return true;
        }
        
        if (step === 2) {
            const fullName = document.getElementById('fullName');
            const phone = document.getElementById('phone');
            const city = document.getElementById('city');
            
            if (!fullName.value) {
                fullName.classList.add('is-invalid');
                return false;
            }
            
            if (!phone.value || phone.value.length < 10) {
                phone.classList.add('is-invalid');
                return false;
            }
            
            if (!city.value) {
                city.classList.add('is-invalid');
                return false;
            }
            
            return true;
        }
        
        return true;
    }
    
    // Password strength meter
    document.getElementById('password').addEventListener('input', function() {
        const password = this.value;
        const strength = document.getElementById('passwordStrength');
        const hint = document.getElementById('passwordHint');
        
        if (password.length === 0) {
            strength.className = 'password-strength';
            hint.textContent = 'Minimum 8 characters';
        } else if (password.length < 8) {
            strength.className = 'password-strength weak';
            hint.textContent = 'Too short';
        } else if (password.length < 12 || !/[A-Z]/.test(password) || !/[0-9]/.test(password)) {
            strength.className = 'password-strength medium';
            hint.textContent = 'Medium strength';
        } else {
            strength.className = 'password-strength strong';
            hint.textContent = 'Strong password';
        }
    });
    
    // Confirm password validation
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        if (this.value !== password) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });
    
    // OTP inputs auto-focus
    document.querySelectorAll('.otp-input').forEach((input, index, inputs) => {
        input.addEventListener('input', function() {
            if (this.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            updateOtpHidden();
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
                inputs[index - 1].focus();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const digits = paste.replace(/\D/g, '').split('');
            digits.forEach((digit, i) => {
                if (inputs[i]) {
                    inputs[i].value = digit;
                }
            });
            updateOtpHidden();
        });
    });
    
    function updateOtpHidden() {
        const otp = Array.from(document.querySelectorAll('.otp-input'))
            .map(input => input.value)
            .join('');
        document.getElementById('otpHidden').value = otp;
    }
    
    function startCountdown() {
        let seconds = 59;
        document.getElementById('resendTimer').classList.remove('d-none');
        document.getElementById('resendBtn').classList.add('d-none');
        
        countdownInterval = setInterval(() => {
            seconds--;
            document.getElementById('countdown').textContent = `0:${seconds.toString().padStart(2, '0')}`;
            
            if (seconds <= 0) {
                clearInterval(countdownInterval);
                document.getElementById('resendTimer').classList.add('d-none');
                document.getElementById('resendBtn').classList.remove('d-none');
            }
        }, 1000);
    }
    
    function resendOTP() {
        // TODO: Implement OTP resend AJAX call
        startCountdown();
        alert('OTP resent to your phone number');
    }
    
    // Email availability check (debounced)
    let emailTimeout;
    document.getElementById('email').addEventListener('input', function() {
        clearTimeout(emailTimeout);
        const email = this.value;
        const emailError = document.getElementById('emailError');
        const emailValid = document.getElementById('emailValid');
        
        this.classList.remove('is-invalid', 'is-valid');
        emailError.textContent = '';
        emailValid.classList.add('d-none');
        
        if (email && email.includes('@')) {
            emailTimeout = setTimeout(() => {
                // TODO: Implement actual email check via AJAX
                // For now, simulate check
                this.classList.add('is-valid');
                emailValid.classList.remove('d-none');
                feather.replace();
            }, 500);
        }
    });
</script>
{% endblock %}
