{% comment %}
Offer Modal Component
Usage: {% include 'components/offer_modal.html' %}
{% endcomment %}

<div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="offerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-light" id="offerModalLabel">Make an Offer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="offerForm" action="" method="post">
                    <input type="hidden" name="csrfmiddlewaretoken" value="">
                    <input type="hidden" name="watch_id" id="offerWatchId">
                    
                    <!-- Watch Info Summary -->
                    <div class="d-flex align-items-center p-3 bg-black rounded mb-4">
                        <div class="me-3" style="width:60px;height:60px;background:#1a1a1a;border-radius:8px;display:flex;align-items:center;justify-content:center;">
                            <span data-feather="watch" style="width:28px;height:28px;color:var(--wb-primary);"></span>
                        </div>
                        <div>
                            <p class="text-light mb-0" id="offerWatchName">Watch Name</p>
                            <p class="text-primary mb-0">Asking: <strong id="offerAskingPrice">Rs. 0</strong></p>
                        </div>
                    </div>
                    
                    <!-- Offer Amount -->
                    <div class="mb-4">
                        <label class="form-label text-muted">Your Offer</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-black border-secondary text-primary">Rs.</span>
                            <input type="number" class="form-control bg-dark border-secondary text-light" 
                                   id="offerAmount" name="amount" placeholder="Enter your offer" required>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">Quick offers:</small>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary quick-offer" data-percent="90">90%</button>
                                <button type="button" class="btn btn-outline-secondary quick-offer" data-percent="85">85%</button>
                                <button type="button" class="btn btn-outline-secondary quick-offer" data-percent="80">80%</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transaction Method -->
                    <div class="mb-4">
                        <label class="form-label text-muted">Transaction Method</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="offer-method-option selected" data-method="meeting">
                                    <input type="radio" name="transaction_method" value="meeting" checked>
                                    <div class="d-flex align-items-center">
                                        <span data-feather="map-pin" class="text-primary me-2" style="width:20px;height:20px;"></span>
                                        <div>
                                            <span class="text-light d-block">Karachi Meeting</span>
                                            <small class="text-success">Free</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="offer-method-option" data-method="delivery">
                                    <input type="radio" name="transaction_method" value="delivery">
                                    <div class="d-flex align-items-center">
                                        <span data-feather="truck" class="text-primary me-2" style="width:20px;height:20px;"></span>
                                        <div>
                                            <span class="text-light d-block">Delivery</span>
                                            <small class="text-muted">+Rs. 800</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message (Optional) -->
                    <div class="mb-4">
                        <label class="form-label text-muted">Message (Optional)</label>
                        <textarea class="form-control bg-dark border-secondary text-light" 
                                  id="offerMessage" name="message" rows="2" 
                                  placeholder="Add a personal note to your offer..."></textarea>
                    </div>
                    
                    <!-- Offer Validity -->
                    <div class="mb-4">
                        <label class="form-label text-muted">Offer Valid For</label>
                        <select class="form-select bg-dark border-secondary text-light" name="validity">
                            <option value="24">24 hours</option>
                            <option value="48" selected>48 hours</option>
                            <option value="72">72 hours</option>
                            <option value="168">7 days</option>
                        </select>
                    </div>
                    
                    <!-- Terms -->
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="offerTerms" required>
                        <label class="form-check-label text-muted" for="offerTerms">
                            I understand that this is a binding offer and I commit to purchase if accepted
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitOffer()">
                    <span data-feather="send" style="width:16px;height:16px;"></span> Send Offer
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .offer-method-option {
        background-color: #1a1a1a;
        border: 2px solid #333;
        border-radius: 10px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .offer-method-option:hover {
        border-color: #555;
    }
    
    .offer-method-option.selected {
        border-color: var(--wb-primary);
        background-color: rgba(198, 169, 97, 0.1);
    }
    
    .offer-method-option input {
        display: none;
    }
    
    #offerModal .form-control,
    #offerModal .form-select {
        border-radius: 8px;
    }
    
    #offerModal .form-control:focus,
    #offerModal .form-select:focus {
        border-color: var(--wb-primary);
        box-shadow: 0 0 0 3px rgba(198, 169, 97, 0.2);
    }
    
    .quick-offer {
        border-color: #444;
        color: #888;
    }
    
    .quick-offer:hover {
        background-color: var(--wb-primary);
        border-color: var(--wb-primary);
        color: #000;
    }
</style>

<script>
    let currentWatchPrice = 0;
    
    function openOfferModal(watchId, watchName, askingPrice) {
        currentWatchPrice = askingPrice;
        
        document.getElementById('offerWatchId').value = watchId;
        document.getElementById('offerWatchName').textContent = watchName;
        document.getElementById('offerAskingPrice').textContent = 'Rs. ' + askingPrice.toLocaleString();
        document.getElementById('offerAmount').value = '';
        document.getElementById('offerMessage').value = '';
        document.getElementById('offerTerms').checked = false;
        
        // Reset method selection
        document.querySelectorAll('.offer-method-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector('.offer-method-option[data-method="meeting"]').classList.add('selected');
        document.querySelector('input[name="transaction_method"][value="meeting"]').checked = true;
        
        // Set form action
        document.getElementById('offerForm').action = `/watches/${watchId}/offer/`;
        
        // Get CSRF token from cookie
        const csrfToken = getCookie('csrftoken');
        document.querySelector('#offerForm input[name="csrfmiddlewaretoken"]').value = csrfToken;
        
        const modal = new bootstrap.Modal(document.getElementById('offerModal'));
        modal.show();
        
        feather.replace();
    }
    
    // Quick offer buttons
    document.querySelectorAll('.quick-offer').forEach(btn => {
        btn.addEventListener('click', function() {
            const percent = parseInt(this.dataset.percent);
            const offerAmount = Math.floor(currentWatchPrice * (percent / 100));
            document.getElementById('offerAmount').value = offerAmount;
        });
    });
    
    // Transaction method selection
    document.querySelectorAll('.offer-method-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.offer-method-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            this.querySelector('input').checked = true;
        });
    });
    
    function submitOffer() {
        const form = document.getElementById('offerForm');
        const termsChecked = document.getElementById('offerTerms').checked;
        const amount = document.getElementById('offerAmount').value;
        
        if (!amount) {
            alert('Please enter an offer amount');
            return;
        }
        
        if (!termsChecked) {
            alert('Please accept the terms to proceed');
            return;
        }
        
        // Submit via AJAX
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('offerModal')).hide();
                
                // Show success message
                showToast('Offer sent successfully!', 'success');
            } else {
                alert(data.message || 'Failed to submit offer. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function showToast(message, type = 'info') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'info'} position-fixed`;
        toast.style.cssText = 'top:20px;right:20px;z-index:9999;min-width:300px;';
        toast.innerHTML = `
            <span data-feather="${type === 'success' ? 'check-circle' : 'info'}" style="width:18px;height:18px;"></span>
            ${message}
        `;
        document.body.appendChild(toast);
        feather.replace();
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>
