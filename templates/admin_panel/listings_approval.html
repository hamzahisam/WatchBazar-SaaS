{% extends 'base_admin.html' %}
{% load static %}
{% load humanize %}

{% block title %}Listing Approval - Admin{% endblock %}

{% block admin_title %}Listing Approval{% endblock %}

{% block admin_content %}
<!-- Stats -->
<div class="row g-4 mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="kpi-card">
            <div class="kpi-icon bg-warning bg-opacity-10">
                <span data-feather="clock" class="text-warning"></span>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Pending</p>
                <h3 class="kpi-value">{{ pending_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="kpi-card">
            <div class="kpi-icon bg-success bg-opacity-10">
                <span data-feather="check-circle" class="text-success"></span>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Approved Today</p>
                <h3 class="kpi-value">{{ approved_today }}</h3>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="kpi-card">
            <div class="kpi-icon bg-danger bg-opacity-10">
                <span data-feather="x-circle" class="text-danger"></span>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Rejected Today</p>
                <h3 class="kpi-value">{{ rejected_today }}</h3>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="kpi-card">
            <div class="kpi-icon bg-info bg-opacity-10">
                <span data-feather="clock" class="text-info"></span>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Avg Review Time</p>
                <h3 class="kpi-value">{{ avg_review_time }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Filters & View Toggle -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex gap-2">
        <select class="form-select bg-dark border-secondary text-light" style="width:auto;" id="statusFilter">
            <option value="pending" selected>Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="">All</option>
        </select>
        <select class="form-select bg-dark border-secondary text-light" style="width:auto;" id="brandFilter">
            <option value="">All Brands</option>
            {% for brand in brands %}
            <option value="{{ brand }}">{{ brand }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-secondary active" id="gridViewBtn" onclick="setView('grid')">
            <span data-feather="grid" style="width:16px;height:16px;"></span>
        </button>
        <button class="btn btn-outline-secondary" id="listViewBtn" onclick="setView('list')">
            <span data-feather="list" style="width:16px;height:16px;"></span>
        </button>
    </div>
</div>

<!-- Grid View -->
<div id="gridView" class="row g-4">
    {% for listing in listings %}
    <div class="col-md-6 col-xl-4">
        <div class="card bg-dark border-0 h-100">
            <!-- Image Carousel -->
            <div class="position-relative">
                <img src="{{ listing.primary_image.url }}" alt="{{ listing.model }}" 
                     style="width:100%;height:200px;object-fit:cover;border-radius:8px 8px 0 0;">
                {% if listing.images.count > 1 %}
                <span class="badge bg-dark position-absolute" style="bottom:10px;right:10px;">
                    <span data-feather="image" style="width:12px;height:12px;"></span> {{ listing.images.count }}
                </span>
                {% endif %}
                <span class="badge 
                    {% if listing.status == 'pending' %}bg-warning text-dark
                    {% elif listing.status == 'approved' %}bg-success
                    {% elif listing.status == 'rejected' %}bg-danger{% endif %} 
                    position-absolute" style="top:10px;left:10px;">
                    {{ listing.status|title }}
                </span>
            </div>
            
            <div class="card-body">
                <p class="text-primary small mb-1">{{ listing.brand }}</p>
                <h6 class="text-light mb-2">{{ listing.model }}</h6>
                <p class="text-primary fw-bold mb-3">Rs. {{ listing.price|floatformat:0|intcomma }}</p>
                
                <div class="d-flex justify-content-between text-muted small mb-3">
                    <span>{{ listing.condition }}</span>
                    <span>{{ listing.movement_type }}</span>
                </div>
                
                <div class="d-flex align-items-center">
                    <img src="{{ listing.seller.logo.url|default:'/static/assets/img/default-store.png' }}" 
                         style="width:24px;height:24px;border-radius:50%;object-fit:cover;" class="me-2" alt="">
                    <span class="text-muted small">{{ listing.seller.store_name }}</span>
                </div>
            </div>
            
            <div class="card-footer bg-transparent border-0 pt-0">
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-light btn-sm flex-grow-1" onclick="viewListingDetails({{ listing.id }})">
                        <span data-feather="eye" style="width:14px;height:14px;"></span> View
                    </button>
                    {% if listing.status == 'pending' %}
                    <button class="btn btn-success btn-sm" onclick="approveListing({{ listing.id }})">
                        <span data-feather="check" style="width:14px;height:14px;"></span>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="rejectListing({{ listing.id }})">
                        <span data-feather="x" style="width:14px;height:14px;"></span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="text-center py-5">
            <span data-feather="check-circle" style="width:60px;height:60px;color:#28a745;" class="mb-3"></span>
            <h5 class="text-light mb-2">All Caught Up!</h5>
            <p class="text-muted">No pending listings to review.</p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- List View (Hidden by default) -->
<div id="listView" class="d-none">
    <div class="card bg-dark border-0">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark mb-0">
                    <thead>
                        <tr>
                            <th>Listing</th>
                            <th>Price</th>
                            <th>Seller</th>
                            <th>Submitted</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for listing in listings %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="{{ listing.primary_image.url }}" 
                                         style="width:50px;height:50px;object-fit:cover;border-radius:6px;" class="me-3" alt="">
                                    <div>
                                        <p class="text-primary small mb-0">{{ listing.brand }}</p>
                                        <p class="text-light mb-0">{{ listing.model }}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="text-primary">Rs. {{ listing.price|floatformat:0|intcomma }}</td>
                            <td>{{ listing.seller.store_name }}</td>
                            <td class="text-muted">{{ listing.created_at|timesince }} ago</td>
                            <td>
                                <span class="badge 
                                    {% if listing.status == 'pending' %}bg-warning text-dark
                                    {% elif listing.status == 'approved' %}bg-success
                                    {% elif listing.status == 'rejected' %}bg-danger{% endif %}">
                                    {{ listing.status|title }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-outline-light btn-sm" onclick="viewListingDetails({{ listing.id }})">
                                    <span data-feather="eye" style="width:14px;height:14px;"></span>
                                </button>
                                {% if listing.status == 'pending' %}
                                <button class="btn btn-success btn-sm" onclick="approveListing({{ listing.id }})">
                                    <span data-feather="check" style="width:14px;height:14px;"></span>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="rejectListing({{ listing.id }})">
                                    <span data-feather="x" style="width:14px;height:14px;"></span>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if listings.has_other_pages %}
<nav class="mt-4">
    <ul class="pagination justify-content-center mb-0">
        {% if listings.has_previous %}
        <li class="page-item">
            <a class="page-link bg-dark border-secondary text-light" href="?page={{ listings.previous_page_number }}">Previous</a>
        </li>
        {% endif %}
        
        {% for num in listings.paginator.page_range %}
        <li class="page-item {% if listings.number == num %}active{% endif %}">
            <a class="page-link {% if listings.number == num %}bg-primary border-primary text-dark{% else %}bg-dark border-secondary text-light{% endif %}" 
               href="?page={{ num }}">{{ num }}</a>
        </li>
        {% endfor %}
        
        {% if listings.has_next %}
        <li class="page-item">
            <a class="page-link bg-dark border-secondary text-light" href="?page={{ listings.next_page_number }}">Next</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Listing Detail Modal -->
<div class="modal fade" id="listingDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title text-light">Listing Review</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="listingDetailContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer border-0" id="listingDetailFooter">
                <!-- Actions loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title text-light">Reject Listing</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rejectListingId">
                <div class="mb-3">
                    <label class="form-label text-muted">Rejection Reason</label>
                    <select class="form-select bg-dark border-secondary text-light" id="rejectReason">
                        <option value="">Select a reason</option>
                        <option value="poor_images">Poor Quality Images</option>
                        <option value="incomplete_info">Incomplete Information</option>
                        <option value="price_issue">Unrealistic Price</option>
                        <option value="fake">Suspected Counterfeit</option>
                        <option value="duplicate">Duplicate Listing</option>
                        <option value="policy">Policy Violation</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Feedback for Seller</label>
                    <textarea class="form-control bg-dark border-secondary text-light" id="rejectFeedback" rows="3" 
                              placeholder="Provide feedback to help the seller improve their listing..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()">
                    Reject Listing
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function setView(view) {
        if (view === 'grid') {
            document.getElementById('gridView').classList.remove('d-none');
            document.getElementById('listView').classList.add('d-none');
            document.getElementById('gridViewBtn').classList.add('active');
            document.getElementById('listViewBtn').classList.remove('active');
        } else {
            document.getElementById('gridView').classList.add('d-none');
            document.getElementById('listView').classList.remove('d-none');
            document.getElementById('gridViewBtn').classList.remove('active');
            document.getElementById('listViewBtn').classList.add('active');
        }
    }
    
    document.getElementById('statusFilter').addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);
        params.set('status', this.value);
        window.location.search = params.toString();
    });
    
    document.getElementById('brandFilter').addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);
        params.set('brand', this.value);
        window.location.search = params.toString();
    });
    
    function viewListingDetails(listingId) {
        fetch(`/admin/listings/${listingId}/details/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('listingDetailContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <img src="${data.primary_image}" class="img-fluid rounded" alt="">
                        </div>
                        ${data.images.length > 1 ? `
                        <div class="d-flex gap-2 flex-wrap">
                            ${data.images.map(img => `
                                <img src="${img}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;" alt="">
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                    <div class="col-md-6">
                        <p class="text-primary mb-1">${data.brand}</p>
                        <h4 class="text-light mb-2">${data.model}</h4>
                        ${data.model_number ? `<p class="text-muted mb-3">Ref: ${data.model_number}</p>` : ''}
                        
                        <h3 class="text-primary mb-4">Rs. ${data.price.toLocaleString()}</h3>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-6">
                                <p class="text-muted small mb-1">Condition</p>
                                <p class="text-light mb-0">${data.condition}</p>
                            </div>
                            <div class="col-6">
                                <p class="text-muted small mb-1">Movement</p>
                                <p class="text-light mb-0">${data.movement_type}</p>
                            </div>
                            <div class="col-6">
                                <p class="text-muted small mb-1">Case Material</p>
                                <p class="text-light mb-0">${data.case_material || '—'}</p>
                            </div>
                            <div class="col-6">
                                <p class="text-muted small mb-1">Band Material</p>
                                <p class="text-light mb-0">${data.band_material || '—'}</p>
                            </div>
                        </div>
                        
                        <hr class="border-secondary">
                        
                        <div class="d-flex align-items-center mb-3">
                            <img src="${data.seller.logo || '/static/assets/img/default-store.png'}" 
                                 style="width:40px;height:40px;border-radius:50%;object-fit:cover;" class="me-3" alt="">
                            <div>
                                <p class="text-light mb-0">${data.seller.store_name}</p>
                                <small class="text-muted">${data.seller.business_type}</small>
                            </div>
                            ${data.seller.is_verified ? '<span class="badge bg-success ms-auto">Verified</span>' : ''}
                        </div>
                    </div>
                </div>
                
                <hr class="border-secondary my-4">
                
                <h6 class="text-primary mb-3">Description</h6>
                <p class="text-muted">${data.description}</p>
            `;
            
            if (data.status === 'pending') {
                document.getElementById('listingDetailFooter').innerHTML = `
                    <button class="btn btn-outline-danger" onclick="rejectListing(${data.id})">Reject</button>
                    <button class="btn btn-success" onclick="approveListing(${data.id})">Approve Listing</button>
                `;
            } else {
                document.getElementById('listingDetailFooter').innerHTML = `
                    <span class="badge ${data.status === 'approved' ? 'bg-success' : 'bg-danger'} me-auto">${data.status}</span>
                    <button class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
                `;
            }
            
            new bootstrap.Modal(document.getElementById('listingDetailModal')).show();
        });
    }
    
    function approveListing(listingId) {
        fetch(`/admin/listings/${listingId}/approve/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to approve listing');
            }
        });
    }
    
    function rejectListing(listingId) {
        document.getElementById('rejectListingId').value = listingId;
        document.getElementById('rejectReason').value = '';
        document.getElementById('rejectFeedback').value = '';
        
        // Close detail modal if open
        const detailModal = bootstrap.Modal.getInstance(document.getElementById('listingDetailModal'));
        if (detailModal) detailModal.hide();
        
        new bootstrap.Modal(document.getElementById('rejectModal')).show();
    }
    
    function confirmReject() {
        const listingId = document.getElementById('rejectListingId').value;
        const reason = document.getElementById('rejectReason').value;
        const feedback = document.getElementById('rejectFeedback').value;
        
        if (!reason) {
            alert('Please select a rejection reason');
            return;
        }
        
        fetch(`/admin/listings/${listingId}/reject/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason, feedback })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to reject listing');
            }
        });
    }
</script>
{% endblock %}
