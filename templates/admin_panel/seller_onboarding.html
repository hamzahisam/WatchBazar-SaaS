{% extends 'base_admin.html' %}
{% load static %}
{% load humanize %}

{% block title %}Seller Onboarding - Admin{% endblock %}

{% block admin_title %}Seller Onboarding{% endblock %}

{% block admin_content %}
<!-- Stats -->
<div class="row g-4 mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="kpi-card">
            <div class="kpi-icon bg-warning bg-opacity-10">
                <span data-feather="clock" class="text-warning"></span>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Pending Review</p>
                <h3 class="kpi-value">{{ pending_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="kpi-card">
            <div class="kpi-icon bg-success bg-opacity-10">
                <span data-feather="check-circle" class="text-success"></span>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Approved Today</p>
                <h3 class="kpi-value">{{ approved_today }}</h3>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="kpi-card">
            <div class="kpi-icon bg-danger bg-opacity-10">
                <span data-feather="x-circle" class="text-danger"></span>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Rejected Today</p>
                <h3 class="kpi-value">{{ rejected_today }}</h3>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="kpi-card">
            <div class="kpi-icon bg-primary bg-opacity-10">
                <span data-feather="users" class="text-primary"></span>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Total Sellers</p>
                <h3 class="kpi-value">{{ total_sellers }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card bg-dark border-0 mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label text-muted small">Status</label>
                <select class="form-select bg-dark border-secondary text-light" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="pending" selected>Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label text-muted small">Business Type</label>
                <select class="form-select bg-dark border-secondary text-light" id="typeFilter">
                    <option value="">All Types</option>
                    <option value="Individual">Individual</option>
                    <option value="Dealer">Dealer</option>
                    <option value="Store">Store</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label text-muted small">City</label>
                <select class="form-select bg-dark border-secondary text-light" id="cityFilter">
                    <option value="">All Cities</option>
                    <option value="Karachi">Karachi</option>
                    <option value="Lahore">Lahore</option>
                    <option value="Islamabad">Islamabad</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-light w-100" onclick="applyFilters()">
                    <span data-feather="filter" style="width:16px;height:16px;"></span> Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sellers Table -->
<div class="card bg-dark border-0">
    <div class="card-body">
        {% if sellers %}
        <div class="table-responsive">
            <table class="table table-dark">
                <thead>
                    <tr>
                        <th>Store</th>
                        <th>Owner</th>
                        <th>Business Type</th>
                        <th>City</th>
                        <th>Applied</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for seller in sellers %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="{{ seller.logo.url|default:'/static/assets/img/default-store.png' }}" 
                                     style="width:40px;height:40px;border-radius:50%;object-fit:cover;" class="me-2" alt="">
                                <div>
                                    <p class="text-light mb-0">{{ seller.store_name }}</p>
                                    <small class="text-muted">{{ seller.email }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ seller.owner_name }}</td>
                        <td>
                            <span class="badge bg-secondary">{{ seller.business_type }}</span>
                        </td>
                        <td>{{ seller.city }}</td>
                        <td>{{ seller.created_at|date:"M d, Y" }}</td>
                        <td>
                            <span class="badge 
                                {% if seller.status == 'pending' %}bg-warning text-dark
                                {% elif seller.status == 'approved' %}bg-success
                                {% elif seller.status == 'rejected' %}bg-danger{% endif %}">
                                {{ seller.status|title }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewSellerDetails({{ seller.id }})">
                                <span data-feather="eye" style="width:14px;height:14px;"></span>
                            </button>
                            {% if seller.status == 'pending' %}
                            <button class="btn btn-success btn-sm" onclick="approveSeller({{ seller.id }})">
                                <span data-feather="check" style="width:14px;height:14px;"></span>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="rejectSeller({{ seller.id }})">
                                <span data-feather="x" style="width:14px;height:14px;"></span>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if sellers.has_other_pages %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center mb-0">
                {% if sellers.has_previous %}
                <li class="page-item">
                    <a class="page-link bg-dark border-secondary text-light" href="?page={{ sellers.previous_page_number }}">Previous</a>
                </li>
                {% endif %}
                
                {% for num in sellers.paginator.page_range %}
                <li class="page-item {% if sellers.number == num %}active{% endif %}">
                    <a class="page-link {% if sellers.number == num %}bg-primary border-primary text-dark{% else %}bg-dark border-secondary text-light{% endif %}" 
                       href="?page={{ num }}">{{ num }}</a>
                </li>
                {% endfor %}
                
                {% if sellers.has_next %}
                <li class="page-item">
                    <a class="page-link bg-dark border-secondary text-light" href="?page={{ sellers.next_page_number }}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <span data-feather="users" style="width:60px;height:60px;color:#444;" class="mb-3"></span>
            <h5 class="text-light mb-2">No Sellers Found</h5>
            <p class="text-muted">No seller applications match your criteria.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Seller Detail Modal -->
<div class="modal fade" id="sellerDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title text-light">Seller Application Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sellerDetailContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer border-0" id="sellerDetailFooter">
                <!-- Actions loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title text-light">Reject Seller Application</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rejectSellerId">
                <div class="mb-3">
                    <label class="form-label text-muted">Rejection Reason</label>
                    <select class="form-select bg-dark border-secondary text-light" id="rejectReason">
                        <option value="">Select a reason</option>
                        <option value="incomplete_docs">Incomplete Documentation</option>
                        <option value="invalid_id">Invalid ID/CNIC</option>
                        <option value="suspicious">Suspicious Activity</option>
                        <option value="duplicate">Duplicate Account</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Additional Notes</label>
                    <textarea class="form-control bg-dark border-secondary text-light" id="rejectNotes" rows="3" 
                              placeholder="Provide additional details..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()">
                    Reject Application
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function applyFilters() {
        const status = document.getElementById('statusFilter').value;
        const type = document.getElementById('typeFilter').value;
        const city = document.getElementById('cityFilter').value;
        
        const params = new URLSearchParams();
        if (status) params.set('status', status);
        if (type) params.set('type', type);
        if (city) params.set('city', city);
        
        window.location.search = params.toString();
    }
    
    function viewSellerDetails(sellerId) {
        fetch(`/admin/sellers/${sellerId}/details/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('sellerDetailContent').innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center mb-4 mb-md-0">
                        <img src="${data.logo || '/static/assets/img/default-store.png'}" 
                             style="width:100px;height:100px;border-radius:50%;object-fit:cover;" class="mb-3" alt="">
                        <h5 class="text-light mb-1">${data.store_name}</h5>
                        <span class="badge bg-secondary">${data.business_type}</span>
                    </div>
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-6">
                                <p class="text-muted small mb-1">Owner Name</p>
                                <p class="text-light mb-0">${data.owner_name}</p>
                            </div>
                            <div class="col-6">
                                <p class="text-muted small mb-1">Phone</p>
                                <p class="text-light mb-0">${data.phone}</p>
                            </div>
                            <div class="col-6">
                                <p class="text-muted small mb-1">Email</p>
                                <p class="text-light mb-0">${data.email}</p>
                            </div>
                            <div class="col-6">
                                <p class="text-muted small mb-1">City</p>
                                <p class="text-light mb-0">${data.city}</p>
                            </div>
                            <div class="col-12">
                                <p class="text-muted small mb-1">Address</p>
                                <p class="text-light mb-0">${data.address || 'â€”'}</p>
                            </div>
                            <div class="col-12">
                                <p class="text-muted small mb-1">CNIC Number</p>
                                <p class="text-light mb-0">${data.cnic}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="border-secondary my-4">
                
                <h6 class="text-primary mb-3">Uploaded Documents</h6>
                <div class="row g-3">
                    ${data.cnic_front ? `
                    <div class="col-md-6">
                        <p class="text-muted small mb-2">CNIC Front</p>
                        <img src="${data.cnic_front}" class="img-fluid rounded" alt="">
                    </div>
                    ` : ''}
                    ${data.cnic_back ? `
                    <div class="col-md-6">
                        <p class="text-muted small mb-2">CNIC Back</p>
                        <img src="${data.cnic_back}" class="img-fluid rounded" alt="">
                    </div>
                    ` : ''}
                </div>
                
                <hr class="border-secondary my-4">
                
                <h6 class="text-primary mb-3">Business Description</h6>
                <p class="text-muted">${data.description || 'No description provided.'}</p>
            `;
            
            if (data.status === 'pending') {
                document.getElementById('sellerDetailFooter').innerHTML = `
                    <button class="btn btn-outline-danger" onclick="rejectSeller(${data.id})">Reject</button>
                    <button class="btn btn-success" onclick="approveSeller(${data.id})">Approve</button>
                `;
            } else {
                document.getElementById('sellerDetailFooter').innerHTML = `
                    <button class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
                `;
            }
            
            new bootstrap.Modal(document.getElementById('sellerDetailModal')).show();
        });
    }
    
    function approveSeller(sellerId) {
        if (confirm('Approve this seller application?')) {
            fetch(`/admin/sellers/${sellerId}/approve/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Failed to approve seller');
                }
            });
        }
    }
    
    function rejectSeller(sellerId) {
        document.getElementById('rejectSellerId').value = sellerId;
        document.getElementById('rejectReason').value = '';
        document.getElementById('rejectNotes').value = '';
        
        // Close detail modal if open
        const detailModal = bootstrap.Modal.getInstance(document.getElementById('sellerDetailModal'));
        if (detailModal) detailModal.hide();
        
        new bootstrap.Modal(document.getElementById('rejectModal')).show();
    }
    
    function confirmReject() {
        const sellerId = document.getElementById('rejectSellerId').value;
        const reason = document.getElementById('rejectReason').value;
        const notes = document.getElementById('rejectNotes').value;
        
        if (!reason) {
            alert('Please select a rejection reason');
            return;
        }
        
        fetch(`/admin/sellers/${sellerId}/reject/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason, notes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to reject seller');
            }
        });
    }
</script>
{% endblock %}
